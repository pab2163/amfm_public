---
title: "Make Plots for Manipulation Checks (Fig. 4)"
author: "Paul Bloom"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

## Load packages
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(brms)
library(cowplot)
library(emmeans)
library(tidybayes)
library(bayestestR)
theme_set(theme_bw())

# Set seed for reproducible run (probably not needed her, but maybe to hold ggplot jitter constant)
seed = 11291993
```


## Load models that were previously fit

```{r}
load('../../results/models/manipulation_check_models.rda')
```


# Music Familiarity Manipulation Check (Fig. 4A)

* Use the `conditional_effects()` function to get the distribution of the expected value of the posterior predictive distribution (from `m1_familiarity`) for the familiarity rating in each condition. Although the model is ordinal, for visualization purposes, data are plotted as continuous here.
* On top of the plot generated, also add raw participant-specific mean familiarity ratings (from `session_data_familiarity_summary`) as blue "spaghetti"

```{r, warning=FALSE, message=FALSE, results='hide'}
familiarity_condition_plot = conditional_effects(m1_familiarity, categorical = FALSE)

# Make aggregated summary for each participant (mean familiarity rating in each condition)
session_data_familiarity_summary = session_data %>%
  dplyr::filter(condition %in% c('F', 'U')) %>%
  group_by(participant_id, condition) %>%
  summarise(mean_familiarity_rating = mean(familiarity))


# Update plot generated by `conditional_effects()` with participant-level raw data
familiarity_condition_plot = plot(familiarity_condition_plot, plot=FALSE, cat_args = list(size = 3), errorbar_args = list(width = 0.1))[[1]] +
  labs(x = 'Condition',
       y = 'Participant-rated familiarity with clips',
       title = '' ) +
  geom_line(data = session_data_familiarity_summary, aes(x = condition, 
                                                     y = mean_familiarity_rating, 
                                                     group = participant_id,
                                                     ymin = 1, ymax = 1),
            alpha = 0.2, color = 'blue', position = position_dodge(0.05)) +
  scale_x_discrete(labels = c('F'='Familiar Music', 'U'='Unfamiliar Music')) +
  theme(text = element_text(face = 'bold'), 
        axis.text = element_text(size = 12), 
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 13),
        strip.text = element_text(size = 12))

```

# Music Exposure Timing Manipulation Check (Fig. 4B)

* Similar to previous plot, generate participant-level summary stats -- the proportion of trials "matching" for each participant in each time window. "Matching" means on a trial, the participant reported highest (or tied for highest) exposure to the song during the time window of release
* Then, generate the posterior predictions from `m2_matching` as a function of the time window using the `conditional_effects()` function. 
* Finally, plot the posterior predictions combined with the raw data participant-level summaries as blue points

```{r, results='hide'}
match_summary = session_data_time_match %>%
  group_by(participant_id, time) %>%
  summarise(match_prop = sum(matching)/n())


time_exposure_plot = plot(conditional_effects(m2_matching))[[1]] +
  geom_jitter(data = match_summary, aes(x = time, y = match_prop, ymin = 1, ymax = 1), 
              height = 0.01, width = .2, alpha = 0.1, color = 'blue') +  
  labs(y = "Likelihood of most reported exposure\nin time window of song release", x = 'Time Period of Music Release', 
       title = '') +
  geom_hline(yintercept = 0.8, lty = 2, color = 'Purple2') +
  scale_x_discrete(labels = c('child'='Childhood\n5-9 years', 'adol'='Adolescence\n14-18 years',
                              'adult'='Young Adulthood\n20-25 years'), 
                   limits = c('child', 'adol', 'adult')) +
  scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
   theme(text = element_text(face = 'bold'), 
        axis.text = element_text(size = 12), 
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 13),
        strip.text = element_text(size = 12))

```

# Spontaneous Music-Evoked Recall Manipulation Check (Fig. 4C)

* Use the `conditional_effects()` function to get the distribution of the expected value of the posterior predictive distribution (from `m3_spontaneous`) for the likelihood of a spontaneous memory in each condition. 
* On top of the plot generated, also add raw participant-specific mean familiarity ratings (from `spontaneous_summary`) as blue "spaghetti"

```{r,results='hide'}
spontaneous_summary = session_data %>%
  dplyr::filter(!is.na(spont_memory), spont_memory !=0) %>%
  mutate(spont_memory = dplyr::recode(spont_memory, 'y'=1, 'n'=0)) %>%
  group_by(condition, participant_id) %>%
  summarise(spont_prob = sum(spont_memory)/n())

spontaneous_memory_plot = plot(conditional_effects(m3_spontaneous))[[1]] +
  labs(y  = 'Likelihood of Spontaneous Memory', x = 'Condition', title = '') +
  ylim(0,1) +
  geom_line(data = spontaneous_summary, aes(x = condition, y = spont_prob, group = participant_id, ymin = 1, ymax = 1), 
            alpha = 0.2, color = 'blue',
            position = position_dodge(0.05)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.x = element_blank()) +
  scale_x_discrete(labels = c('F'='Familiar Music', 'U'='Unfamiliar Music', 'C'='Non-music clips'),
                   limits = c('F', 'U', 'C')) +
  theme(text = element_text(face = 'bold'), 
        axis.text = element_text(size = 11), axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        strip.text = element_text(size = 12))
```

# Check for coincidence between spontaneous and prompted recall (Fig. 4D)

* Use the `conditional_effects()` function to get the distribution of the expected value of the posterior predictive distribution (from `m4_coincidence`) for the likelihood of a spontaneous memory in each condition. 
* Plot with extra aesthetics

```{r,results='hide'}
coincidence_plot = plot(conditional_effects(m4_coincidence))[[1]] +
  labs(y = 'Likelihood of Coincidence\nbetween spontaneous & prompted memory',  x = 'Condition', title = '') +
  scale_x_discrete(labels = c('F'='Familiar Music', 'U'='Unfamiliar Music', 'C'='Non-music clips'),
                   limits = c('F', 'U', 'C')) +
  theme(text = element_text(face = 'bold'), 
        axis.text = element_text(size = 10.5), 
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 13),
        strip.text = element_text(size = 12))
```

# Make panel plot Figure 4

* Put together all four panels in Fig. 4 using `cowplot::plot_grid()`, then save to the `/results` folder

```{r}
prelim_grid = cowplot::plot_grid(familiarity_condition_plot, time_exposure_plot, 
                   spontaneous_memory_plot, coincidence_plot, labels = c('A ', 'B', 'C', 'D'))

cowplot::save_plot(prelim_grid, filename = '../../results/fig4_manip_check.png', 
                   base_width = 12, base_height = 10)
```
